[tox]
envlist = {core,airflow}-{py37,py39}-{airflow_1_10_15,airflow_2_2_3},manifest
toxworkdir = {toxinidir}/../../.tox/dbnd-run
# install pip==21.3.1 for python 3.6
requires = pip==21.3.1

[dbnd]
home = {toxinidir}/../..
tests = tests
modules = {[dbnd]home}/modules
plugins = {[dbnd]home}/plugins

[testenv]
# Python 3.6+ has a number of compile-time warnings on invalid string escapes.
# PYTHONWARNINGS=d and --no-compile below make them visible during the Tox run.
install_command = pip install --no-compile {opts} {packages}

# Prevent random setuptools/pip breakages like
# https://github.com/pypa/setuptools/issues/1042 from breaking our builds.
setenv =
	VIRTUALENV_NO_DOWNLOAD = 1
    DBND_HOME = {[dbnd]home}
	AIRFLOW__CORE__SQL_ALCHEMY_CONN = sqlite:///{[tox]toxworkdir}/airflow-{envname}-unittest.db
    SLUGIFY_USES_TEXT_UNIDECODE=yes
	DBND__CORE__TRACKER = ['file', 'console']

    py37: PYTHON_VERSION=3.7
    py39: PYTHON_VERSION=3.9

    airflow_1_10_15: AIRFLOW_VERSION=1.10.15
    airflow_2_2_3: AIRFLOW_VERSION=2.2.3


whitelist_externals = rm

filterwarnings =
	once::Warning: Django>=1.5,<1.6
	ignore::ResourceWarning

deps =
    -e {[dbnd]modules}/dbnd
    -e {[dbnd]modules}/dbnd[tests]
    -e {[dbnd]plugins}/dbnd-run
    -e {[dbnd]plugins}/dbnd-run[tests]
    -e {[dbnd]plugins}/dbnd-test-scenarios

    airflow_2_2_3: apache-airflow=={env:AIRFLOW_VERSION}
    airflow_2_2_3: -c https://raw.githubusercontent.com/apache/airflow/constraints-{env:AIRFLOW_VERSION}/constraints-no-providers-{env:PYTHON_VERSION}.txt

    airflow_1_10_15: apache-airflow==1.10.15
    airflow_1_10_15: marshmallow-sqlalchemy==0.18.0
	airflow_1_10_15: werkzeug<1.0
	airflow_1_10_15: SQLAlchemy==1.3.20
	airflow_1_10_15: WTForms<2.4

commands =
	coverage erase
	core: pytest tests/core --junit-xml build/junit-{envname}.xml {posargs}
	airflow: pytest tests/airflow --junit-xml build/junit-{envname}.xml  {posargs}

	#  coverage report

[testenv:manifest]
basepython = python3.9
deps = check-manifest
skip_install = true
commands = check-manifest
